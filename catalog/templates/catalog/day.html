{% extends "catalog/base.html" %}
{% block content %}
<h2 class="h4 mb-3">{{ date|date:"l, F j, Y" }}</h2>

{% if is_blocked %}
    <div class="alert alert-warning mb-3">
    This date has been <strong>Blocked for Booking</strong>. Existing events are still shown,
    but new bookings are not allowed on this day.
    </div>
{% endif %}

<table class="table table-bordered align-middle text-center white-table day-table">
  <thead class="table-light">
    <tr>
      <th style="width:10rem;">Time</th>
      {% for r in rooms %}
        <th class="
          {% if r.status != 'a' %} room-unavailable {% endif %}
        ">
          {{ r.name }}
          {% if r.status == 'r' %}
            <span class="badge bg-warning text-dark ms-1">Reserved</span>
          {% elif r.status == 'u' %}
            <span class="badge bg-secondary ms-1">Unavailable</span>
          {% endif %}
        </th>
      {% endfor %}
    </tr>
  </thead>

  <tbody>
    {% for row in rows %}
      <tr>
        <th scope="row">{{ row.hour|add:0 }}:00 – {{ row.hour|add:2 }}:00</th>

        {% for c in row.cells %}
          <td class="{% if not c.is_room_available %} room-unavailable {% endif %}">

          {# CASE 1 — Approved booking already exists #}
          {% if c.has_approved %}
              <span class="badge text-bg-secondary">Booked</span><br>

              {% for ev in c.events %}
                  {% if user.is_superuser %}
                      <a href="{% url 'catalog:event_detail' ev.pk %}">
                        {{ ev.name }}{% if not ev.approved %} (pending){% endif %}
                      </a>

                      <div class="mb-2 d-flex gap-1 justify-content-center">
                        <a href="{% url 'catalog:event_update' ev.pk %}?next={{ request.path }}"
                           class="btn btn-sm btn-primary">Edit</a>
                        <a href="{% url 'catalog:event_delete' ev.pk %}?next={{ request.path }}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Are you sure you want to delete this event?');">
                           Delete
                        </a>
                      </div>

                  {% elif ev.planner and ev.planner.user == user %}
                      <a href="{% url 'catalog:event_detail' ev.pk %}">
                        {{ ev.name }}{% if not ev.approved %} (pending){% endif %}
                      </a>

                      <div class="mb-2 d-flex gap-1 justify-content-center">
                        <a href="{% url 'catalog:event_update' ev.pk %}?next={{ request.path }}"
                           class="btn btn-sm btn-primary">Edit</a>
                        <a href="{% url 'catalog:event_delete' ev.pk %}?next={{ request.path }}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Are you sure you want to delete this event?');">
                           Delete
                        </a>
                      </div>

                  {% else %}
                      <a href="{% url 'catalog:event_detail' ev.pk %}">{{ ev.name }}</a>
                  {% endif %}
              {% endfor %}

          {# CASE 2 — No approved event, handle pending + booking logic #}
          {% else %}

              {# SUPERUSER pending events #}
              {% if user.is_superuser %}
                  {% if c.events %}
                      <span class="text-muted small">Pending events:</span><br>
                      {% for ev in c.events %}
                          <a href="{% url 'catalog:event_detail' ev.pk %}">{{ ev.name }} (pending)</a>
                          <div class="mb-2 d-flex gap-1 justify-content-center">
                            <a href="{% url 'catalog:event_update' ev.pk %}?next={{ request.path }}"
                               class="btn btn-sm btn-primary">Edit</a>
                            <a href="{% url 'catalog:event_delete' ev.pk %}?next={{ request.path }}"
                               class="btn btn-sm btn-danger"
                               onclick="return confirm('Are you sure you want to delete this event?');">
                               Delete
                            </a>
                          </div>
                      {% endfor %}
                  {% endif %}

                  {% if can_book and not is_blocked and c.is_room_available %}
                      {% if c.events %}
                        <a href="{{ c.book_url }}" class="btn btn-outline-primary btn-sm">Book another</a>
                      {% else %}
                        <a href="{{ c.book_url }}" class="btn btn-primary btn-sm">Book</a>
                      {% endif %}
                  {% elif not c.is_room_available %}
                      <span class="text-muted small">Room Unavailable</span>
                  {% endif %}

              {# PLANNER pending events #}
              {% elif c.events and c.events.0.planner and c.events.0.planner.user == user %}
                  <span class="text-muted small">Your pending event(s):</span><br>
                  {% for ev in c.events %}
                      <a href="{% url 'catalog:event_detail' ev.pk %}">{{ ev.name }} (pending)</a>
                      <div class="mb-2 d-flex gap-1 justify-content-center">
                        <a href="{% url 'catalog:event_update' ev.pk %}?next={{ request.path }}"
                           class="btn btn-sm btn-primary">Edit</a>
                        <a href="{% url 'catalog:event_delete' ev.pk %}?next={{ request.path }}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Are you sure you want to delete this event?');">
                           Delete
                        </a>
                      </div>
                  {% endfor %}

                  {% if can_book and not is_blocked and c.is_room_available %}
                      {% if c.events %}
                        <a href="{{ c.book_url }}" class="btn btn-outline-primary btn-sm">Book another</a>
                      {% else %}
                        <a href="{{ c.book_url }}" class="btn btn-primary btn-sm">Book</a>
                      {% endif %}
                  {% elif not c.is_room_available %}
                      <span class="text-muted small">Room Unavailable</span>
                  {% endif %}

              {# NORMAL USER #}
              {% else %}
                  {% if can_book and not is_blocked and c.is_room_available %}
                      <a href="{{ c.book_url }}" class="btn btn-primary btn-sm">Book</a>
                  {% else %}
                      {% if not c.is_room_available %}
                          <span class="text-muted small">Room Unavailable</span>
                      {% else %}
                          <span class="text-muted small">Available</span>
                      {% endif %}
                  {% endif %}
              {% endif %}
          {% endif %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<a href="/" class="btn back-btn">Back to Calendar</a>
{% endblock %}